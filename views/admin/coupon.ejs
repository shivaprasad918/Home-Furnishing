<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Corona Admin</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- End layout styles -->
  <link rel="shortcut icon" href="assets/images/favicon.png" />
</head>

<body>
  <div class="container-scroller">
    <!-- partial:../../partials/_sidebar.html -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
        <a class="sidebar-brand brand-logo" href="index.html"><img src="assets/images/logo.svg" alt="logo" /></a>
        <a class="sidebar-brand brand-logo-mini" href="index.html"><img src="assets/images/logo-mini.svg"
            alt="logo" /></a>
      </div>
      <ul class="nav">
        <li class="nav-item profile">
          <div class="profile-desc">
            <div class="profile-pic">
              <div class="count-indicator">
                <img class="img-xs rounded-circle " src="assets/images/faces/face15.jpg" alt="">
                <span class="count bg-success"></span>
              </div>
              <div class="profile-name">
                <h5 class="mb-0 font-weight-normal">Shivaprasad</h5>
                <span>Gold Member</span>
              </div>
            </div>
            <a href="#" id="profile-dropdown" data-toggle="dropdown"><i class="mdi mdi-dots-vertical"></i></a>
            <div class="dropdown-menu dropdown-menu-right sidebar-dropdown preview-list"
              aria-labelledby="profile-dropdown">
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-settings text-primary"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Account settings</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-onepassword  text-info"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Change Password</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-calendar-today text-success"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">To-do list</p>
                </div>
              </a>
            </div>
          </div>
        </li>
        <li class="nav-item nav-category">
          <span class="nav-link">Navigation</span>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/dashboard">
            <span class="menu-icon">
              <i class="mdi mdi-speedometer"></i>
            </span>
            <span class="menu-title">Dashboard</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/User">
            <span class="menu-icon">
              <i class="mdi mdi-laptop"></i>
            </span>
            <span class="menu-title">User</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allCategory">
            <span class="menu-icon">
              <i class="mdi mdi-chart-bar"></i>
            </span>
            <span class="menu-title">Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/category">
            <span class="menu-icon">
              <i class="mdi mdi-table-large"></i>
            </span>
            <span class="menu-title">Add Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">All products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/addProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Add products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/order">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Orders</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/coupon">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Coupons</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/offer">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Offer</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/salesReport">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Sales Report</span>
          </a>
        </li>

      </ul>
    </nav>



    <div class="container mt-5">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped w-100">
              <thead class="thead-dark">
                <tr>
                  <th>Coupon Name</th>
                  <th>Coupon Code</th>
                  <th>Created</th>
                  <th>Expiry Date</th>
                  <th>Minimum Purchase</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                <% coupon.forEach(coupon=> { %>
                  <tr data-id="<%= coupon._id %>">
                    <td>
                      <%= coupon.couponName %>
                    </td>
                    <td>
                      <%= coupon.couponCode %>
                    </td>
                    <td>
                      <%= coupon.validFrom %>
                    </td>
                    <td>
                      <%= coupon.validUntil %>
                    </td>
                    <td>
                      <%= coupon.minPurchaseAmount %>
                    </td>
                    <td><button class="btn btn-danger delete-coupon">Delete</button></td>
                  </tr>
                  <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-end my-5">
        <button class="btn btn-outline-primary" data-toggle="modal" data-target="#addCouponModal">Add Coupon</button>
      </div>
    </div>

    <!-- Add Coupon Modal -->
    <div class="modal fade" id="addCouponModal" tabindex="-1" role="dialog" aria-labelledby="addCouponModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCouponModalLabel">Add Coupon</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="couponForm">
              <p class="text-danger" id="displayerror"></p>
              <div class="form-group">
                <label for="couponName">Coupon Name:</label>
                <input type="text" id="couponName" name="couponName" class="form-control" required>
                <div class="invalid-feedback  " id="couponNameError"></div>
              </div>
              <div class="form-group">
                <label for="discount">Discount:</label>
                <input type="number" id="discount" name="discount" class="form-control" required>
              </div>
              <p class="invalid-feedback text-success" style="color: aqua;" id="discountError"></p>
              <div class="form-group">
                <label for="validFrom">Valid From:</label>
                <input type="date" id="validFrom" name="validFrom" class="form-control" required>
                <div class="invalid-feedback" id="validFromError"></div>
              </div>
              <div class="form-group">
                <label for="validUntil">Valid Until:</label>
                <input type="date" id="validUntil" name="validUntil" class="form-control" required>
                <div class="invalid-feedback" id="validUntilError"></div>
              </div>
              <div class="form-group">
                <label for="minPurchaseAmount">Minimum Purchase Amount:</label>
                <input type="number" id="minPurchaseAmount" name="minPurchaseAmount" class="form-control" required>
                <div class="invalid-feedback" id="minPurchaseAmountError"></div>
              </div>
              <button type="submit" class="btn btn-primary">Create Coupon</button>
            </form>
          </div>
        </div>
      </div>
    </div>



    <script>
      document.getElementById('couponForm').addEventListener('submit', function (event) {
    event.preventDefault(); 

    var couponNameError = document.getElementById('displayerror');
    var discountError = document.getElementById('displayerror');
    var validFromError = document.getElementById('displayerror');
    var validUntilError = document.getElementById('displayerror');
    var minPurchaseAmountError = document.getElementById('displayerror');

    // Clear previous error messages
    couponNameError.textContent = '';
    discountError.textContent = '';
    validFromError.textContent = '';
    validUntilError.textContent = '';
    minPurchaseAmountError.textContent = '';

    const couponName = document.getElementById('couponName').value.trim();
    const discount = parseFloat(document.getElementById('discount').value); 
    const validFrom = new Date(document.getElementById('validFrom').value);
    const validUntil = new Date(document.getElementById('validUntil').value);
    const minPurchaseAmount = parseFloat(document.getElementById('minPurchaseAmount').value);

    let isValid = true;

    // Validation
    if (!couponName) {
        couponNameError.textContent = 'Please enter the coupon name.';
        isValid = false;
    }

    if (isNaN(discount) || discount <= 0 || discount > 100) {
        discountError.innerHTML = 'Please enter a valid discount between 1 and 100.';
        isValid = false;
    }

    if (isNaN(validFrom.getTime())) {
        validFromError.textContent = 'Please enter a valid start date.';
        isValid = false;
    }

    if (isNaN(validUntil.getTime())) {
        validUntilError.textContent = 'Please enter a valid end date.';
        isValid = false;
    }

    if (validFrom >= validUntil) {
        validFromError.textContent = 'The start date must be before the end date.';
        isValid = false;
    }

    if (isNaN(minPurchaseAmount) || minPurchaseAmount <= 0) {
        minPurchaseAmountError.textContent = 'Please enter a valid minimum purchase amount.';
        isValid = false;
    }

    if (isValid) {
        // Collect form data
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        // Submit form data via axios
        axios.post('/admin/createCoupon', data)
            .then(response => {
                if (response.data.message) {
                    Swal.fire({
                        title: 'Success!',
                        text: response.data.message,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Reload the page to update the table
                        location.reload();
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error!',
                    text: error.response.data.error || 'Something went wrong!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
    }
});
      // Delete coupon event listener
      document.querySelectorAll('.delete-coupon').forEach(button => {
        button.addEventListener('click', function () {
          const couponRow = this.closest('tr');
          const couponId = couponRow.getAttribute('data-id');

          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
            if (result.isConfirmed) {
              axios.delete(`/admin/deleteCoupon/${couponId}`)
                .then(response => {
                  if (response.data.message) {
                    Swal.fire(
                      'Deleted!',
                      'Your coupon has been deleted.',
                      'success'
                    );
                    // Remove the deleted coupon row from the table
                    couponRow.remove();
                  }
                })
                .catch(error => {
                  Swal.fire({
                    title: 'Error!',
                    text: error.response.data.error || 'Something went wrong!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                  });
                });
            }
          });
        });
      });
    </script>




    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/hoverable-collapse.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <!-- End custom js for this page -->
</body>

</html>