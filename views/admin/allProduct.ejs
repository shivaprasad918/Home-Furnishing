<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Corona Admin</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- End layout styles -->
  <link rel="shortcut icon" href="assets/images/favicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <div class="container-scroller">
    <!-- partial:../../partials/_sidebar.html -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
        <a class="sidebar-brand brand-logo" href="index.html"><img src="assets/images/logo.svg" alt="logo" /></a>
        <a class="sidebar-brand brand-logo-mini" href="index.html"><img src="assets/images/logo-mini.svg"
            alt="logo" /></a>
      </div>
      <ul class="nav">
        <li class="nav-item profile">
          <div class="profile-desc">
            <div class="profile-pic">
              <div class="count-indicator">
                <img class="img-xs rounded-circle " src="assets/images/faces/face15.jpg" alt="">
                <span class="count bg-success"></span>
              </div>
              <div class="profile-name">
                <h5 class="mb-0 font-weight-normal">Shivaprasad</h5>
                <span>Gold Member</span>
              </div>
            </div>
            <a href="#" id="profile-dropdown" data-toggle="dropdown"><i class="mdi mdi-dots-vertical"></i></a>
            <div class="dropdown-menu dropdown-menu-right sidebar-dropdown preview-list"
              aria-labelledby="profile-dropdown">
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-settings text-primary"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Account settings</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-onepassword  text-info"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Change Password</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-calendar-today text-success"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">To-do list</p>
                </div>
              </a>
            </div>
          </div>
        </li>
        <li class="nav-item nav-category">
          <span class="nav-link">Navigation</span>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/dashboard">
            <span class="menu-icon">
              <i class="mdi mdi-speedometer"></i>
            </span>
            <span class="menu-title">Dashboard</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/User">
            <span class="menu-icon">
              <i class="mdi mdi-laptop"></i>
            </span>
            <span class="menu-title">User</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allCategory">
            <span class="menu-icon">
              <i class="mdi mdi-chart-bar"></i>
            </span>
            <span class="menu-title">Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/category">
            <span class="menu-icon">
              <i class="mdi mdi-table-large"></i>
            </span>
            <span class="menu-title">Add Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">All products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/addProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Add products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/order">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Orders</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/coupon">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Coupons</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/offer">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Offer</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/salesReport">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Sales Report</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- <div>
        <h2 class="head mt-4">All products</h2>
    </div> -->
    <div class="container mt-5">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped w-100">
              <thead class="thead-dark">
                <tr>
                  <th>Product Name</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Brand</th>
                  <th>Category</th>
                  <th>Subcategory</th>
                  <th>Offers</th>
                  <th>Edit</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach(product=> { %>
                  <tr>
                    <td>
                      <%= product.productName %>
                    </td>
                    <td>
                      <%= product.price.toFixed(2) %>
                    </td>
                    <td>
                      <%= product.quantity %>
                    </td>
                    <td>
                      <%= product.brand %>
                    </td>
                    <td>
                      <%= product.category ? product.category.categoryName : 'N/A' %>
                    </td>
                    <td>
                      <%= product.category ? product.category.subCategory : 'N/A' %>
                    </td>
                    <td>
                      <% if (product.offer) { %>
                        <button class="btn btn-warning remove-offer" data-product-id="<%= product._id %>">Remove Offer</button>
                      <% } else { %>
                        <button class="btn btn-success apply-offer" data-product-id="<%= product._id %>">Apply Offer</button>
                      <% } %>
                    </td>
                    
                    
                    <td><a href="/admin/editProduct/<%= product._id %>" class="btn btn-primary">Edit</a></td>
                    <td>
                      <form id="deleteForm" action="/admin/delete-products/<%= product._id %>/delete" method="POST">
                        <button type="submit" id="confirmDeleteButton" class="btn btn-danger">Delete</button>
                      </form>
                    </td>
                  </tr>
                  <% }) %>
              </tbody>
            </table>

            <!-- Offer Modal -->
            <style>
              .modal-dialog-custom {
                max-width: 30%;
                /* Adjust this value as needed */
              }
            </style>

            <div class="modal fade" id="offerModal" tabindex="-1" role="dialog" aria-labelledby="offerModalLabel"
              aria-hidden="true">
              <div class="modal-dialog modal-dialog-custom" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="offerModalLabel">Available Offers</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div id="offerList">
                      <% offers.forEach(offer=> { %>
                        <div class="card mb-3">
                          <div class="card-body">
                            <h5 class="card-title">
                              <%= offer.name %> (<%= offer.percentage %>% Off)
                            </h5>
                            <p class="card-text">Valid from <%= offer.startDate %> to <%= offer.endDate %>
                            </p>
                            <button class="btn btn-primary select-offer" data-offer-id="<%= offer._id %>">Select
                              Offer</button>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                <% if (currentPage> 1) { %>
                  <li class="page-item">
                    <a class="page-link" href="?page=<%= currentPage - 1 %>" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                  <% } %>

                    <% for (let i=1; i <=totalPages; i++) { %>
                      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                        <a class="page-link" href="?page=<%= i %>">
                          <%= i %>
                        </a>
                      </li>
                      <% } %>

                        <% if (currentPage < totalPages) { %>
                          <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage + 1 %>" aria-label="Next">
                              <span aria-hidden="true">&raquo;</span>
                            </a>
                          </li>
                          <% } %>
                     </ul>
                </nav>
          </div>

          <style>
            .pagination {
              border-radius: 0.25rem;
            }

            .page-item.active .page-link {
              background-color: #007bff;
              border-color: #007bff;
              color: white;
            }

            .page-link {
              border: 1px solid #dee2e6;
              border-radius: 0.25rem;
              padding: 0.5rem 0.75rem;
            }

            .page-link:hover {
              background-color: #e9ecef;
            }
          </style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
  const applyOfferButtons = document.querySelectorAll('.apply-offer');
  const removeOfferButtons = document.querySelectorAll('.remove-offer');

  // Apply Offer Functionality
  applyOfferButtons.forEach(button => {
    button.addEventListener('click', function () {
      const productId = this.getAttribute('data-product-id');
      $('#offerModal').modal('show');

      const selectOfferButtons = document.querySelectorAll('.select-offer');

      selectOfferButtons.forEach(selectButton => {
        selectButton.addEventListener('click', function () {
          const offerId = this.getAttribute('data-offer-id');
          const offerName = this.parentElement.querySelector('.card-title').innerText;

          Swal.fire({
            title: 'Apply Offer',
            text: `Are you sure you want to apply "${offerName}" to this product?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Apply',
            cancelButtonText: 'Cancel'
          }).then((result) => {
            if (result.isConfirmed) {
              applyOffer(productId, offerId);
            }
          });
        });
      });
    });
  });

  // Remove Offer Functionality
  removeOfferButtons.forEach(button => {
    button.addEventListener('click', function () {
      const productId = this.getAttribute('data-product-id');

      Swal.fire({
        title: 'Remove Offer',
        text: 'Are you sure you want to remove the offer from this product?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Remove',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          removeOffer(productId);
        }
      });
    });
  });

  function applyOffer(productId, offerId) {
    axios.post(`/admin/applyOffer/${productId}`, { offerId })
      .then(response => {
        Swal.fire({
          title: 'Success!',
          text: response.data.message,
          icon: 'success',
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.reload(); // Reload the page to reflect changes
        });
      })
      .catch(error => {
        Swal.fire({
          title: 'Error!',
          text: error.response.data.error || 'Failed to apply offer.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
  }

  function removeOffer(productId) {
    axios.post(`/admin/removeOffer/${productId}`)
      .then(response => {
        Swal.fire({
          title: 'Success!',
          text: response.data.message,
          icon: 'success',
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.reload(); // Reload the page to reflect changes
        });
      })
      .catch(error => {
        Swal.fire({
          title: 'Error!',
          text: error.response.data.error || 'Failed to remove offer.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
  }
});

</script>

        </div>
      </div>
    </div>


  </div>












  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Select all buttons with ids starting with "confirmDeleteButton"
      document.querySelectorAll('[id^="confirmDeleteButton"]').forEach(function (button) {
        button.addEventListener('click', function (event) {
          // Prevent the default action (which is nothing in this case)
          event.preventDefault();

          // Extract the form ID from the button ID
          const formId = event.target.id.replace('confirmDeleteButton', 'deleteForm');
          const form = document.getElementById(formId);

          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
            if (result.isConfirmed) {
              form.submit(); // Manually submit the form if the user confirms
            }
          });
        });
      });
    });

  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="assets/vendors/js/vendor.bundle.base.js"></script>
  <!-- endinject -->
  <!-- Plugin js for this page -->
  <!-- End plugin js for this page -->
  <!-- inject:js -->
  <script src="assets/js/off-canvas.js"></script>
  <script src="assets/js/hoverable-collapse.js"></script>
  <script src="assets/js/misc.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/todolist.js"></script>
  <!-- endinject -->
  <!-- Custom js for this page -->
  <!-- End custom js for this page -->
</body>

</html>