<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Corona Admin</title>
  <!-- plugins:css -->
  <link rel="stylesheet" href="/admin/assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="/admin/assets/vendors/css/vendor.bundle.base.css">
  <!-- endinject -->
  <!-- Plugin css for this page -->
  <!-- End plugin css for this page -->
  <!-- inject:css -->
  <!-- endinject -->
  <!-- Layout styles -->
  <link rel="stylesheet" href="/admin/assets/css/style.css">
  <!-- End layout styles -->
  <link rel="shortcut icon" href="/admin/assets/images/favicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script defer src="https://cdn.crop.guide/loader/l.js?c=QMDKLG"></script>

</head>

<body>
  <div class="container-scroller">
    <!-- partial:../../partials/_sidebar.html -->
    <nav class="sidebar sidebar-offcanvas" id="sidebar">
      <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
        <a class="sidebar-brand brand-logo" href="index.html"><img src="/admin/assets/images/logo.svg" alt="logo" /></a>
        <a class="sidebar-brand brand-logo-mini" href="index.html"><img src="/admin/assets/images/logo-mini.svg"
            alt="logo" /></a>
      </div>
      <ul class="nav">
        <li class="nav-item profile">
          <div class="profile-desc">
            <div class="profile-pic">
              <div class="count-indicator">
                <img class="img-xs rounded-circle " src="/admin/assets/images/faces/face15.jpg" alt="">
                <span class="count bg-success"></span>
              </div>
              <div class="profile-name">
                <h5 class="mb-0 font-weight-normal">Shivaprasad</h5>
                <span>Gold Member</span>
              </div>
            </div>
            <a href="#" id="profile-dropdown" data-toggle="dropdown"><i class="mdi mdi-dots-vertical"></i></a>
            <div class="dropdown-menu dropdown-menu-right sidebar-dropdown preview-list"
              aria-labelledby="profile-dropdown">
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-settings text-primary"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Account settings</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-onepassword  text-info"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">Change Password</p>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item preview-item">
                <div class="preview-thumbnail">
                  <div class="preview-icon bg-dark rounded-circle">
                    <i class="mdi mdi-calendar-today text-success"></i>
                  </div>
                </div>
                <div class="preview-item-content">
                  <p class="preview-subject ellipsis mb-1 text-small">To-do list</p>
                </div>
              </a>
            </div>
          </div>
        </li>
        <li class="nav-item nav-category">
          <span class="nav-link">Navigation</span>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/dashboard">
            <span class="menu-icon">
              <i class="mdi mdi-speedometer"></i>
            </span>
            <span class="menu-title">Dashboard</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/User">
            <span class="menu-icon">
              <i class="mdi mdi-laptop"></i>
            </span>
            <span class="menu-title">User</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allCategory">
            <span class="menu-icon">
              <i class="mdi mdi-chart-bar"></i>
            </span>
            <span class="menu-title">Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/category">
            <span class="menu-icon">
              <i class="mdi mdi-table-large"></i>
            </span>
            <span class="menu-title">Add Category</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/allProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">All products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/addProduct">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Add products</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/order">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Orders</span>
          </a>
        </li>
        <li class="nav-item menu-items">
          <a class="nav-link" href="/admin/coupon">
            <span class="menu-icon">
              <i class="mdi mdi-security"></i>
            </span>
            <span class="menu-title">Coupons</span>
          </a>
        </li>
      </ul>
    </nav>
    <div class="container mt-5">
      <h2>Edit Product</h2>
      <form action="/admin/editProduct/<%= product._id %>" method="post" id="editProductForm"
        enctype="multipart/form-data" onsubmit="return validateForm()">
        <input type="hidden" name="_method" value="PUT">

        <!-- Product Name -->
        <div class="form-group">
          <label for="productName">Product Name:</label>
          <input type="text" class="form-control form-control-sm" id="productName" name="productName"
            value="<%= product.productName %>" required>
          <div class="invalid-feedback">Please enter a product name.</div>
        </div>

        <div class="form-group">
          <label for="brand">Brand</label>
          <input type="text" class="form-control" id="brand" name="brand" value="<%= product.brand %>" required>
      </div>

        <!-- Price, Quantity, and Discount -->
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="productPrice">Price:</label>
            <input type="number" class="form-control form-control-sm" min="1" id="productPrice" name="productPrice"
              value="<%= product.price %>" required>
            <div class="invalid-feedback">Please enter a valid price.</div>
          </div>
          <div class="form-group col-md-4">
            <label for="quantity">Quantity:</label>
            <input type="number" class="form-control form-control-sm" min="1" id="quantity" name="quantity"
              value="<%= product.quantity %>" required>
            <div class="invalid-feedback">Please enter a valid quantity.</div>
          </div>
        </div>

        <!-- Category and Subcategory -->
        <div class="form-group">
          <label for="mainCategory">Category:</label>
          <select class="form-control" id="mainCategory" name="mainCategory" required>
            <% categories.forEach(category=> { %>
              <option value="<%= category %>" <%=product.category.categoryName===category
                ? 'selected' : '' %>><%= category %>
              </option>
              <% }) %>
          </select>
          <div class="invalid-feedback">Please select a category.</div>
        </div>
        <div class="form-group">
          <label for="subCategory">Subcategory:</label>
          <select class="form-control sub-category-select" id="subCategory" name="subCategory" required>
            <option value="<%= product.category.subCategory %>">
              <%= product.category.subCategory %>
            </option>
          </select>
          <div class="invalid-feedback">Please select a subcategory.</div>
        </div>

        <!-- Product Description -->
        <div class="form-group">
          <label for="productDescription">Product Description:</label>
          <textarea class="form-control" id="productDescription" name="productDescription" rows="6"
            required><%= product.description %></textarea>
          <div class="invalid-feedback">Please enter a product description.</div>
        </div>

        <!-- Existing Images -->
        <div class="form-group">
          <label>Existing Images:</label>
          <div class="row">
            <% product.product_image.forEach(image=> { %>
              <div class="col-md-3 mb-3">
                <div class="card">
                  <img src="<%= image.resizedFile %>" alt="Product Image" class="card-img-top">
                  <div class="card-body">
                    <button type="button" onclick="deleteImg('<%= product._id %>', '<%= image._id %>')"
                      class="btn btn-sm btn-danger mt-2">Delete</button>
                  </div>
                </div>
              </div>
              <% }) %>
          </div>
        </div>

        <!-- New Images -->
        <div class="form-group">
          <label for="productImages">New Images:</label>
          <input type="file" class="form-control-file" id="productImages" name="product_image" accept="image/*"
            multiple>
        </div>

        <button type="submit" onclick="update()" class="btn btn-primary">Update Product</button>
      </form>

      <!-- Hidden form for deleting images -->
      <form id="deleteImageForm" method="post" style="display: none;">
        <input type="hidden" name="_method" value="POST">
        <input type="hidden" name="productId" id="deleteProductId">
        <input type="hidden" name="imgId" id="deleteImgId">
      </form>
    </div>



    <script>
      function validateForm() {
        // Reset all inputs to valid state
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
          inputs[i].classList.remove("is-invalid");
        }
        var textareas = document.getElementsByTagName("textarea");
        for (var i = 0; i < textareas.length; i++) {
          textareas[i].classList.remove("is-invalid");
        }

        // Validate required fields
        var isValid = true;
        var productName = document.getElementById("productName");
        if (!productName.value.trim()) {
          productName.classList.add("is-invalid");
          isValid = false;
        }
        var productPrice = document.getElementById("productPrice");
        if (!productPrice.value.trim() || parseFloat(productPrice.value) <= 0) {
          productPrice.classList.add("is-invalid");
          isValid = false;
        }
        var quantity = document.getElementById("quantity");
        if (!quantity.value.trim() || parseInt(quantity.value) <= 0) {
          quantity.classList.add("is-invalid");
          isValid = false;
        }
        var discount = document.getElementById("discount");
        if (discount.value.trim() && parseInt(discount.value) < 0) {
          discount.classList.add("is-invalid");
          isValid = false;
        }
        var mainCategory = document.getElementById("mainCategory");
        if (!mainCategory.value.trim()) {
          mainCategory.classList.add("is-invalid");
          isValid = false;
        }
        var subCategory = document.getElementById("subCategory");
        if (!subCategory.value.trim()) {
          subCategory.classList.add("is-invalid");
          isValid = false;
        }
        var productDescription = document.getElementById("productDescription");
        if (!productDescription.value.trim()) {
          productDescription.classList.add("is-invalid");
          isValid = false;
        }

        return isValid;
      }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script>
      const selectElement = document.getElementById('mainCategory');
      selectElement.addEventListener('change', function (event) {
        const selectedOption = event.target.value;
        axios.post('/admin/fetch-subcategory', { selectedOption })
          .then(response => {
            const subCategorySelect = document.getElementById('subCategory');
            subCategorySelect.innerHTML = '';
            response.data.category.forEach(element => {
              const subcategory = element.subCategory;
              if (typeof subcategory === 'string') {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subCategorySelect.appendChild(option);
              } else {
                console.error('Invalid subcategory value:', subcategory);
              }
            });
          })
          .catch(error => {
            console.error('Error:', error);
          });
      });

      function editProduct(productId) {
        const form = document.getElementById('editProductForm');
        form.action = `/admin/editProduct/${productId}`;
        form.submit();
      }

      function deleteImg(productId, imgId) {
        Swal.fire({
          title: 'Are you sure?',
          text: 'You are about to delete this image.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            // Proceed with deletion
            document.getElementById('deleteProductId').value = productId;
            document.getElementById('deleteImgId').value = imgId;
            document.getElementById('deleteImageForm').action = `/admin/deleteProductImage/${productId}?imgId=${imgId}`;
            document.getElementById('deleteImageForm').submit();

            // Show success message
            Swal.fire(
              'Deleted!',
              'The image has been deleted.',
              'success'
            );
          }
        });
      }

      function update() {
        Swal.fire({
          icon: 'success',
          title: 'Product Updated Successfully',
          showConfirmButton: true  // Use true instead of 'Ok'
        });
      }

    </script>



    <script src="/admin/assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="/admin/assets/js/off-canvas.js"></script>
    <script src="/admin/assets/js/hoverable-collapse.js"></script>
    <script src="/admin/assets/js/misc.js"></script>
    <script src="/admin/assets/js/settings.js"></script>
    <script src="/admin/assets/js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <!-- End custom js for this page -->
</body>

</html>